
<app-products-drawer
  *ngIf="showProducts"
  [selectedRetailer]="selectedRetailer"
  [orderType]="'execution'"
  [orderedProducts]="orderDetails?.items"
  [loadingProducts]="loadingProduct"
  [allProducts]="inventory"
  [productSchemes]="schemes"
  [discountSlabs]="discountSlabs"
    [taxClasses] = "taxClasses"
  [productMerchantDiscount]="merchantDiscount"
  [specialDiscounts]="specialDiscounts"
  (drawerClosed)="closeNewProducts()"
  (productSelected)="addNewProductToOrder($event)"
>
</app-products-drawer>

<app-returned-products
  [productsList]="allProducts"
  [orderReturnedItems]="orderDetails.returned_items"
  (productReturned)="handleReturnedProduct($event)"
  (closeReturned)="closeReturnedModal()"
  *ngIf="showReturned"
>
</app-returned-products>

<!-- Credit and Cheque info - Tailwind Modal -->
<div
  id="exampleModal2"
  *ngIf="showPaymentModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="paymentCancelled()"
>
  <div 
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-lg mx-auto border-t-4 border-t-primary"
    (click)="$event.stopPropagation()"
  >
    <!-- Cheque Modal Header -->
    <div *ngIf="!isCredit" class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Add <span class="font-light text-gray-600 dark:text-gray-400">Cheque Information</span>
        </h5>
        <button
          type="button"
          class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
          (click)="paymentCancelled()"
          aria-label="Close"
        >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        </button>
      </div>

    <!-- Modal Body - Cheque -->
    <div *ngIf="!isCredit" class="px-6 py-5">
      <!-- Payment Type Selection with ng-zorro Radio -->
      <nz-radio-group 
        [(ngModel)]="paymentTypeCheque" 
        (ngModelChange)="onChequePaymentTypeChange()"
        name="paymentTypeCheque"
        class="payment-radio-group flex items-center gap-6 mb-4">
        <label 
          nz-radio 
          nzValue="full"
          class="text-sm font-normal text-gray-700 dark:text-gray-300 cursor-pointer">
          Full Amount
        </label>
        <label 
          nz-radio 
          nzValue="partial"
          class="text-sm font-normal text-gray-700 dark:text-gray-300 cursor-pointer">
          Partial Amount
        </label>
      </nz-radio-group>
      <span
        *ngIf="paymentTypeCheque === '' && isAdded"
        class="text-red-500 text-xs block mb-3"
      >
        Please select a payment method!
      </span>

      <!-- Form Fields with ng-zorro -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Cheque Number -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Cheque Number<span class="text-red-500">*</span>
          </label>
          <input
            nz-input
            type="text"
            id="chequeNum"
            name="cheque_num"
            required
            [(ngModel)]="chequeNumber"
            #chequNo="ngModel"
            placeholder="Enter cheque number"
            class="payment-input rounded-md focus:border-primary hover:border-primary  dark:bg-[#141414] dark:border-[#434343] dark:text-neutral-300"
          />
          <span
            *ngIf="chequNo.errors?.required && isAdded"
            class="text-red-500 text-xs mt-1 block"
          >
            Please add Cheque Number!
          </span>
        </div>

        <!-- Date with ng-zorro DatePicker -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Date<span class="text-red-500">*</span>
          </label>
          <nz-date-picker
            id="datepicker"
            name="payment_date"
            [(ngModel)]="paymentDate"
            #payDate="ngModel"
            nzPlaceHolder="Select date"
            class="payment-datepicker w-full"
            [nzFormat]="'dd/MM/yyyy'"
          ></nz-date-picker>
          <span *ngIf="!paymentDate && isAdded" class="text-red-500 text-xs mt-1 block">
            Please add Payment Date!
          </span>
        </div>

        <!-- Bank Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Bank Name<span class="text-red-500">*</span>
          </label>
          <input
            nz-input
            type="text"
            name="cheque_bank_name"
            id="chequeBankName"
            required
            [(ngModel)]="bankName"
            #bank_Name="ngModel"
            placeholder="Enter bank name"
            class="payment-input rounded-md focus:border-primary hover:border-primary  dark:bg-[#141414] dark:border-[#434343] dark:text-neutral-300"
          />
          <span
            *ngIf="bank_Name.errors?.required && isAdded"
            class="text-red-500 text-xs mt-1 block"
          >
            Please add Bank Name!
          </span>
        </div>

        <!-- Total Amount with ng-zorro InputNumber -->
        <div *ngIf="paymentTypeCheque !== 'full'">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Total Amount<span class="text-red-500">*</span>
          </label>
          <nz-input-number
            [(ngModel)]="chequeAmount"
            #cheqAmount="ngModel"
            [nzMin]="0"
            [nzMax]="cash?.amount_received"
            [nzStep]="1"
            nzPlaceHolder="Enter amount"
            class="payment-input-number w-full rounded-md focus:border-primary hover:border-primary  dark:bg-[#141414] dark:border-[#434343] dark:text-neutral-300" 
            id="Amount1"
            name="cheque_amount"
          ></nz-input-number>
          <span
            *ngIf="cheqAmount.errors?.required && isAdded"
            class="text-red-500 text-xs mt-1 block"
          >
            Please add Total Amount!
          </span>
          <span *ngIf="+chequeAmount === 0 && isAdded" class="text-red-500 text-xs mt-1 block">
            Zero value not allowed
          </span>
          <span
            *ngIf="
              !cheqAmount.errors?.required &&
              chequeAmount > cash?.amount_received &&
              isAdded
            "
            class="text-red-500 text-xs mt-1 block"
          >
            Amount should not be greater than
            {{ cash?.amount_received | number: "1.2-2" }}
          </span>
        </div>
      </div>
    </div>
    <!-- Credit Modal Header -->
    <div *ngIf="isCredit" class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Add <span class="font-light text-gray-600 dark:text-gray-400">Credit Information</span>
      </h5>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="paymentCancelled()"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body - Credit -->
    <div *ngIf="isCredit" class="px-6 py-5">
      <!-- Payment Type Selection with ng-zorro Radio -->
      <nz-radio-group 
        [(ngModel)]="paymentTypeCredit"
        (ngModelChange)="onCreditPaymentTypeChange()"
        name="paymentTypeCredit"
        class="payment-radio-group flex items-center gap-6 mb-4">
        <label 
          nz-radio 
          nzValue="full"
          class="text-sm font-normal text-gray-700 dark:text-gray-300 cursor-pointer">
          Full Amount
        </label>
        <label 
          nz-radio 
          nzValue="partial"
          class="text-sm font-normal text-gray-700 dark:text-gray-300 cursor-pointer">
          Partial Amount
        </label>
      </nz-radio-group>
      <span
        *ngIf="paymentTypeCredit === '' && isAdded"
        class="text-red-500 text-xs block mb-3"
      >
        Please select a payment method!
      </span>

      <!-- Amount Field with ng-zorro InputNumber -->
      <div *ngIf="paymentTypeCredit !== 'full'" class="max-w-md">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Amount<span class="text-red-500">*</span>
        </label>
        <nz-input-number
          [(ngModel)]="creditAmount"
          #credAmount="ngModel"
          [nzMin]="0"
          [nzMax]="dueAmount - (cheque?.amount_received || 0)"
          [nzStep]="1"
          nzPlaceHolder="Enter amount"
          class="payment-input-number w-[250px] rounded-md focus:border-primary hover:border-primary  dark:bg-[#141414] dark:border-[#434343] dark:text-neutral-300"
          name="credit_amount"
        ></nz-input-number>
        <span
          *ngIf="credAmount.errors?.required && isAdded"
          class="text-red-500 text-xs mt-1 block"
        >
          Please add Total Amount!
        </span>
        <span *ngIf="+creditAmount === 0 && isAdded" class="text-red-500 text-xs mt-1 block">
          Zero value not allowed
        </span>
        <span
          *ngIf="
            !credAmount.errors?.required &&
            +creditAmount > dueAmount - (cheque?.amount_received || 0) &&
            isAdded
          "
          class="text-red-500 text-xs mt-1 block"
        >
          Amount should not be greater than {{ (dueAmount - (cheque?.amount_received || 0)) | number: "1.2-2" }}
        </span>
      </div>
    </div>

    <!-- Error Message for Mixed Payment -->
      <div
        *ngIf="
          (paymentTypeCheque === 'partial' && paymentTypeCredit === 'full') ||
          (paymentTypeCheque === 'full' && paymentTypeCredit === 'partial')
        "
      class="px-6 py-4 bg-red-50 dark:bg-red-900/20 border-t border-b border-red-200 dark:border-red-800"
    >
      <p class="text-red-600 dark:text-red-400 text-sm font-medium">
        You have to choose "Partial Amount" to use both Credit and Cheque Payment!
      </p>
      </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-gray-50 dark:bg-[#151515] border-t border-gray-200 dark:border-[#303030] rounded-b-lg flex justify-end gap-3">
      <button
        type="button"
        id="close-payment-modal"
        class="px-6 py-2 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors"
        (click)="paymentCancelled()"
        aria-label="Close"
      >
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="
          (paymentTypeCheque === 'partial' && paymentTypeCredit === 'full') ||
          (paymentTypeCheque === 'full' && paymentTypeCredit === 'partial')
        "
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:border-gray-400"
        (click)="addPaymentMethod()"
      >
        Add
      </button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 pb-6 mt-4">
 
      <div class="bg-white px-1 pb-2 border-1 border-t-2 border-t-primary border-gray-200 dark:bg-[#252525] dark:border-[#333333] dark:border-t-primary rounded-lg relative shadow-[0_0_5px_#0000001a] dark:shadow-[0_0_5px_rgba(255,255,255,0.05)]">
        <!-- Tabs Navigation - Pure Tailwind CSS with Dark Mode -->
        <div class="w-full mb-3 grid grid-cols-5" role="tablist" id="pills-tab">
          <!-- Orders Tab -->
          <div class="flex items-center justify-center relative">
            <button type="button"
              class="relative w-full pt-2 pb-6 px-5 text-center transition-all duration-200 font-primary text-[15px] font-light"
              [ngClass]="{
                'bg-white dark:bg-[#252525] text-secondary dark:text-neutral-300 cursor-pointer': currentTab === 1,
                'text-gray-400 dark:text-[#808080] hover:text-gray-600 dark:hover:text-[#b0b0b0] cursor-pointer': currentTab !== 1,
                'text-gray-300 dark:text-[#808080] cursor-not-allowed': false
              }" (click)="changeTab(1, 'direct')" role="tab"
              aria-selected="currentTab === 1" id="pills-home-tab">
              <span class="block" [ngClass]="{
                  'font-semibold text-primary dark:text-neutral-300': currentTab === 1,
                  'font-normal': currentTab !== 1
                }">Orders</span>
              <span
                class="absolute left-1/2 -translate-x-1/2 w-[38px] h-[38px] rounded-full border-2 border-white dark:border-[#252525] flex items-center justify-center transition-all duration-200 z-[5]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#1e54d3] to-primary': currentTab === 1,
                  'bg-gray-300 dark:bg-[#808080] dark:border-[#2a2a2a]': currentTab !== 1
                }"> 
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-[20px] h-[20px] text-white"  viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                  </svg>
              </span>
            </button>
            <!-- Active tab bottom border (blue) -->
            <div *ngIf="currentTab === 1"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-primary dark:bg-[#a0a0a0] transition-all duration-200"></div>
            <!-- Inactive tab bottom border (gray) -->
            <div *ngIf="currentTab !== 1"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-gray-300 dark:bg-[#444444] transition-all duration-200">
            </div>
          </div>

          <!-- Spot Sale Tab -->
          <div class="flex items-center justify-center relative">
            <button type="button"
              class="relative w-full pt-2 pb-6 px-5 text-center transition-all duration-200 font-primary text-[15px] font-light"
              [ngClass]="{
                'bg-white dark:bg-[#252525] text-secondary dark:text-neutral-300 cursor-pointer': currentTab === 2,
                'text-gray-400 dark:text-[#808080] hover:text-gray-600 dark:hover:text-[#b0b0b0] cursor-pointer': currentTab !== 2,
                'text-gray-300 dark:text-[#808080] cursor-not-allowed': false
              }" (click)="changeTab(2, 'direct')" role="tab"
              aria-selected="currentTab === 2" id="pills-sale-tab">
              <span class="block" [ngClass]="{
                  'font-semibold text-primary dark:text-neutral-300': currentTab === 2,
                  'font-normal': currentTab !== 2
                }">Spot Sale</span>
              <span
                class="absolute left-1/2 -translate-x-1/2 w-[38px] h-[38px] rounded-full border-2 border-white dark:border-[#252525] flex items-center justify-center transition-all duration-200 z-[5]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#1e54d3] to-primary': currentTab === 2,
                  'bg-gray-300 dark:bg-[#808080] dark:border-[#2a2a2a]': currentTab !== 2
                }"> 
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-[20px] h-[20px] text-white" viewBox="0 0 16 16">
                    <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73z"/>
                  </svg>
              </span>
            </button>
            <!-- Active tab bottom border (blue) -->
            <div *ngIf="currentTab === 2"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-primary dark:bg-[#a0a0a0] transition-all duration-200"></div>
            <!-- Inactive tab bottom border (gray) -->
            <div *ngIf="currentTab !== 2"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-gray-300 dark:bg-[#444444] transition-all duration-200">
            </div>
          </div>

          <!-- Load Recovery Tab -->
          <div class="flex items-center justify-center relative">
            <button type="button"
              class="relative w-full pt-2 pb-6 px-5 text-center transition-all duration-200 font-primary text-[15px] font-light"
              [ngClass]="{
                'bg-white dark:bg-[#252525] text-secondary dark:text-neutral-300 cursor-pointer': currentTab === 3,
                'text-gray-400 dark:text-[#808080] hover:text-gray-600 dark:hover:text-[#b0b0b0] cursor-pointer': currentTab !== 3,
                'text-gray-300 dark:text-[#808080] cursor-not-allowed': false
              }" (click)="changeTab(3, 'direct')" role="tab"
              aria-selected="currentTab === 3" id="pills-load-recovery-tab">
              <span class="block" [ngClass]="{
                  'font-semibold text-primary dark:text-neutral-300': currentTab === 3,
                  'font-normal': currentTab !== 3
                }">Load Recovery</span>
              <span
                class="absolute left-1/2 -translate-x-1/2 w-[38px] h-[38px] rounded-full border-2 border-white dark:border-[#252525] flex items-center justify-center transition-all duration-200 z-[5]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#1e54d3] to-primary': currentTab === 3,
                  'bg-gray-300 dark:bg-[#808080] dark:border-[#2a2a2a]': currentTab !== 3
                }"> 
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-[20px] h-[20px] text-white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                  </svg>
              </span>
            </button>
            <!-- Active tab bottom border (blue) -->
            <div *ngIf="currentTab === 3"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-primary dark:bg-[#a0a0a0] transition-all duration-200"></div>
            <!-- Inactive tab bottom border (gray) -->
            <div *ngIf="currentTab !== 3"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-gray-300 dark:bg-[#444444] transition-all duration-200">
            </div>
          </div>

          <!-- Recovery Tab -->
          <div class="flex items-center justify-center relative">
            <button type="button"
              class="relative w-full pt-2 pb-6 px-5 text-center transition-all duration-200 font-primary text-[15px] font-light"
              [ngClass]="{
                'bg-white dark:bg-[#252525] text-secondary dark:text-neutral-300 cursor-pointer': currentTab === 4,
                'text-gray-400 dark:text-[#808080] hover:text-gray-600 dark:hover:text-[#b0b0b0] cursor-pointer': currentTab !== 4,
                'text-gray-300 dark:text-[#808080] cursor-not-allowed': false
              }" (click)="changeTab(4, 'direct')" role="tab"
              aria-selected="currentTab === 4" id="pills-recovery-tab">
              <span class="block" [ngClass]="{
                  'font-semibold text-primary dark:text-neutral-300': currentTab === 4,
                  'font-normal': currentTab !== 4
                }">Recovery</span>
              <span
                class="absolute left-1/2 -translate-x-1/2 w-[38px] h-[38px] rounded-full border-2 border-white dark:border-[#252525] flex items-center justify-center transition-all duration-200 z-[5]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#1e54d3] to-primary': currentTab === 4,
                  'bg-gray-300 dark:bg-[#808080] dark:border-[#2a2a2a]': currentTab !== 4
                }">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-[20px] h-[20px] text-white" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                </svg>
              </span>
            </button>
            <!-- Active tab bottom border (blue) -->
            <div *ngIf="currentTab === 4"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-primary dark:bg-[#a0a0a0] transition-all duration-200"></div>
            <!-- Inactive tab bottom border (gray) -->
            <div *ngIf="currentTab !== 4"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-gray-300 dark:bg-[#444444] transition-all duration-200">
            </div>
          </div>

          <!-- Final Tab -->
          <div class="flex items-center justify-center relative">
            <button type="button"
              class="relative w-full pt-2 pb-6 px-5 text-center transition-all duration-200 font-primary text-[15px] font-light"
              [ngClass]="{
                'bg-white dark:bg-[#252525] text-secondary dark:text-neutral-300 cursor-pointer': currentTab === 5,
                'text-gray-400 dark:text-[#808080] hover:text-gray-600 dark:hover:text-[#b0b0b0] cursor-pointer': currentTab !== 5,
                'text-gray-300 dark:text-[#808080] cursor-not-allowed': false
              }" (click)="changeTab(5, 'direct')" role="tab"
              aria-selected="currentTab === 5" id="pills-final-tab">
              <span class="block" [ngClass]="{
                  'font-semibold text-primary dark:text-neutral-300': currentTab === 5,
                  'font-normal': currentTab !== 5
                }">Final</span>
              <span
                class="absolute left-1/2 -translate-x-1/2 w-[38px] h-[38px] rounded-full border-2 border-white dark:border-[#252525] flex items-center justify-center transition-all duration-200 z-[5]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#1e54d3] to-primary': currentTab === 5,
                  'bg-gray-300 dark:bg-[#808080] dark:border-[#2a2a2a]': currentTab !== 5
                }">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                  class="w-[20px] h-[20px] text-white" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                  <path
                    d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05" />
                </svg>
              </span>
            </button>
            <!-- Active tab bottom border (blue) -->
            <div *ngIf="currentTab === 5"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-primary dark:bg-[#a0a0a0] transition-all duration-200"></div>
            <!-- Inactive tab bottom border (gray) -->
            <div *ngIf="currentTab !== 5"
              class="absolute bottom-0 left-0 right-0 h-[2px] bg-gray-300 dark:bg-[#444444] transition-all duration-200">
            </div>
          </div>
        </div>

        <div class="tab-content" id="pills-tabContent">
          <div
            class="tab-pane tab_M p-0 PT-10 fade"
            *ngIf="currentTab === 1"
            [ngClass]="currentTab === 1 ? 'show active' : ''"
            id="pills-home"
            role="tabpanel"
            aria-labelledby="pills-home-tab"
          >

          <div class="text-[13px] pt-3">
            <div class="flex gap-3">
              <!-- Date -->
       
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="text-gray-900 dark:text-gray-300">Date:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ dispatchSummary?.date || "--" }}
                  </span>
                </div>
              
          
              <!-- Order Booker -->
              
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Order Booker:</strong>
                  <b class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ dispatchSummary?.order_bookers?.join(', ') || "--" }}
                  </b>
                </div>
              
          
              <!-- Territory -->
              
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Territory:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ dispatchSummary?.territories?.join(', ') || "--" }}
                  </span>
                </div>
              
          
              <!-- Total Outlets -->
              
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Total Outlets:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ dispatchSummary?.total_outlets || "--" }}
                  </span>
                </div>
              
          
              <!-- Total Amount -->
              
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Total Amount:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    Rs. {{ dispatchSummary?.total_amount || 0 | number: "1.2-2" }}
                  </span>
                </div>
              
            </div>
          </div>
          

            <div class="flex">
              <div id="orderList-id" class="w-[300px] shrink-0">
                <app-retailer-sub-list
                  [loading]="loading || savingOrder"
                  [currentTab]="currentTab"
                  [retailers]="retailersList"
                  [orderType]="'execution'"
                  (retailerChanged)="getOrderDetailsByRetailer($event)"
                ></app-retailer-sub-list>
              </div>

              <div class="flex-1 pl-3 pr-2">
                <div class="h-[calc(100vh-256px)] overflow-y-auto">
                  <app-order-items-list
                    *ngIf="!savingOrder && selectedRetailer"
                    [currentTab]="currentTab"
                    [orderDetail]="orderDetails"
                    [returnAmount]="returnAmount"
                    [dueAmount]="dueAmount"
                    [isChequeAdded]="isChequeAdded"
                    [isCreditAdded]="isCreditAdded"
                    [receivableAmount]="receivableAmount"
                    [totalPayment]="totalPayment"
                    [cheque]="cheque"
                    [credit]="credit"
                    [cash]="cash"
                    [orders]="retailersList"
                    [schemes]="schemes"
                    [loyaltyoffers]="loyaltyoffers"
                    [selectedRetailer]="selectedRetailer"
                    [returnedProduct]="returnedProduct"
                    [allProducts]="inventory"
                    [specialDiscounts]="specialDiscounts"
                    [merchantDiscount]="merchantDiscount"
                    [discountSlabs]="discountSlabs"
                    [taxClasses] = "taxClasses"
                    [newProduct]="newProduct"
                    [orderType]="'execution'"
                    [recoveryAmount]="recoveryAmount"
                    (deleteReturned)="deleteReturnedProduct($event)"
                    (openDrawer)="openProductsList()"
                    (openReturnedModal)="openReturnedModal()"
                    (productUpdated)="calculateReceivable()"
                  >
                  </app-order-items-list>
                  <div class="col-12" *ngIf="savingOrder">
                    <app-loader-white></app-loader-white>
                  </div>
                  <div *ngIf="!savingOrder && !selectedRetailer" class="no-content w-full h-[calc(100vh-256px)] flex">
                    <div class="no-content-container m-auto table text-center text-[#b7b7b7] dark:text-gray-500">
                      <img src="assets/images/select order-icon.svg" alt=""
                        class="w-[70px] h-[70px] mx-auto mb-[10px] block dark:invert dark:opacity-70" />
                      <strong>Select order to see details</strong>
                    </div>
                  </div>
                </div>

                <div
                  *ngIf="!savingOrder && selectedRetailer"
                  class="text-right pt-[15px]"
                >
                  <button
                    *ngIf="!savingOrder && !isChequeAdded"
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    [disabled]="!selectedRetailer"
                    (click)="
                      isCredit = false; isFullyPaymentAdded('Cheque Payment')
                    "
                  >
                    Add Cheque
                  </button>
                  <button
                    *ngIf="!savingOrder && isChequeAdded"
                    [disabled]="!selectedRetailer"
                    class="px-3 py-1.5 leading-none text-[13px] border border-red-600 rounded-[5px] font-primary bg-red-600 text-white hover:bg-red-700 hover:border-red-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="removeCheque()"
                  >
                    Remove Cheque
                  </button>
                  <button
                    *ngIf="!savingOrder && !isCreditAdded"
                    [disabled]="!selectedRetailer"
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="isCredit = true; isFullyPaymentAdded('Credit')"
                  >
                    Add Credit
                  </button>
                  <button
                    *ngIf="!savingOrder && isCreditAdded"
                    [disabled]="!selectedRetailer"
                    class="px-3 py-1.5 leading-none text-[13px] border border-red-600 rounded-[5px] font-primary bg-red-600 text-white hover:bg-red-700 hover:border-red-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="removeCredit()"
                  >
                    Remove Credit
                  </button>
                  <button
                    [disabled]="savingOrder || !selectedRetailer"
                    (click)="saveExecutionQuantity()"
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Save Order
                  </button>

                  <button
                  [disabled]="!orderDetails?.items?.length"
                  *ngIf="!savingOrder"
                  (click)="showHoldModal = true"
                  class="px-3 py-1.5 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors mr-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  > 
                  Hold Order 
                 </button>

                  <button
                    [disabled]="savingOrder || !selectedRetailer"
                    class="px-3 py-1.5 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="showCancelModal = true"
                  >
                    Cancel Order
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div
            class="tab-pane tab_M p-0 PT-10 fade"
            *ngIf="currentTab === 2"
            [ngClass]="currentTab === 2 ? 'show active' : ''"
            id="pills-sale"
            role="tabpanel"
            aria-labelledby="pills-sale-tab"
          >
            <div class="text-[13px] pt-3">
              <div class="flex gap-3">
                <!-- Date -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="text-gray-900 dark:text-gray-300">Date:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ spotSaleOrder.date }}
                  </span>
                </div>
                
                <!-- Order Booker -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Order Booker:</strong>
                  <b class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ spotSaleOrder.orderBookerName }}  
                  </b>
                </div>
                
                <!-- Territory -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Territory:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ spotSaleOrder.territory }}
                  </span>
                </div>
                
                <!-- Total Outlets -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Total Outlets:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ spotSaleOrder.retailers.length }}
                  </span>
                </div>
                
                <!-- Total Amount -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-semibold text-gray-900 dark:text-gray-300">Total Amount:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    Rs. {{ spotSaleOrder.order_total || 0 | number: "1.2-2" }}
                  </span>
                </div>
              </div>
            </div>

            <div class="bg-[#f9f9f9] dark:bg-[#1d1d1d] px-[15px] border border-[#efefef] dark:border-[#333333] py-[10px] mt-3 rounded-lg relative mb-2">
              <div class="flex flex-wrap items-center gap-3">
                <div class="dark:text-gray-200">Order Booker:</div>
                <!-- Order Booker Select -->
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="selectedOrderBooker"
                    (ngModelChange)="getOrderBookerRoutes()"
                    nzPlaceHolder="Select Order Booker"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    class="w-full employee-select"
                  >
                    <nz-option nzDisabled nzLabel="Select Order Booker" [nzValue]="null"></nz-option>
                    <nz-option
                      *ngFor="let item of orderBookers"
                      [nzValue]="item"
                      [nzLabel]="item.employee_first_name + ' ' + item.employee_last_name"
                    ></nz-option>
                  </nz-select>
                </div>

                <!-- Route Select -->
                <div class="dark:text-gray-200">Route:</div>
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="selectedRoute"
                    (ngModelChange)="getRetaielrsByRoute($event)"
                    [nzPlaceHolder]="!selectedOrderBooker ? 'Select Order Booker First' : 'Select Route'"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    [nzDisabled]="!selectedOrderBooker"
                    class="w-full route-select"
                  >
                    <nz-option 
                      *ngIf="!selectedOrderBooker" 
                      nzDisabled 
                      nzLabel="Select Order Booker First" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option 
                      *ngIf="selectedOrderBooker" 
                      nzDisabled 
                      nzLabel="Select Route" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option
                      *ngFor="let item of bookerRoutes"
                      [nzValue]="item.route_id"
                      [nzLabel]="item.name"
                    ></nz-option>
                  </nz-select>
                </div>

                <!-- Retailer Select -->
                <div class="dark:text-gray-200">Retailer:</div>
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="spotRetailer"
                    [nzPlaceHolder]="!selectedRoute ? 'Select Route First' : 'Select Retailer'"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    [nzDisabled]="!selectedRoute"
                    class="w-full retailer-select"
                  >
                    <nz-option 
                      *ngIf="!selectedRoute" 
                      nzDisabled 
                      nzLabel="Select Route First" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option 
                      *ngIf="selectedRoute" 
                      nzDisabled 
                      nzLabel="Select Retailer" 
                      [nzValue]="null"
                    ></nz-option>
                    <ng-container *ngFor="let item of routeRetailers">
                      <nz-option
                        *ngIf="!item.isAdded"
                        [nzValue]="item"
                        [nzLabel]="item.retailer_name"
                      ></nz-option>
                    </ng-container>
                  </nz-select>
                </div>

                <!-- Add Order Button -->
                <button
                  *ngIf="spotRetailer && showAddRetailer"
                  (click)="setSpotSaleRetailer()"
                  class="px-6 py-2 leading-none text-[14px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:bg-blue-700 focus:border-blue-700 transition-all duration-200"
                >
                  Add Order
                </button>
              </div>
            </div>
 

            <div class="flex">
              <div id="orderList-id" class="w-[300px] shrink-0">
                <app-retailer-sub-list
                  [retailers]="spotSaleOrder.retailers"
                  [currentTab]="currentTab"
                  [orderType]="'execution'"
                  [isSpotSaleActive]="isSpotSaleActive"
                  (retailerChanged)="setCurrentSpotSaleOrder($event)"
                ></app-retailer-sub-list>
              </div>

              <div class="flex-1 pl-3 pr-2">
                <div class="h-[calc(100vh-256px)] overflow-y-auto">
                  <app-order-items-list
                    *ngIf="!savingOrder && selectedRetailer"
                    [currentTab]="currentTab"
                    [orderDetail]="orderDetails"
                    [returnAmount]="returnAmount"
                    [isChequeAdded]="isChequeAdded"
                    [isCreditAdded]="isCreditAdded"
                    [receivableAmount]="receivableAmount"
                    [totalPayment]="totalPayment"
                    [cheque]="cheque"
                    [credit]="credit"
                    [orders]="spotSaleOrder.retailers"
                    [cash]="cash"
                    [schemes]="schemes" 
                    [loyaltyoffers]="loyaltyoffers"
                    [dueAmount]="dueAmount"
                    [selectedRetailer]="selectedRetailer"
                    [orderType]="'execution'"
                    [allProducts]="inventory"
                    [specialDiscounts]="specialDiscounts"
                    [merchantDiscount]="merchantDiscount"
                    [discountSlabs]="discountSlabs"
                    [taxClasses] = "taxClasses"
                    [newProduct]="newProduct"
                    (openDrawer)="openProductsList()"
                    (openReturnedModal)="openReturnedModal()"
                    (productUpdated)="calculateReceivable()"
                    (deleteReturned)="deleteReturnedProduct($event)"
                  >
                  </app-order-items-list>
                  <div class="col-12" *ngIf="savingOrder">
                    <app-loader-white></app-loader-white>
                  </div>
                  <div *ngIf="!savingOrder && !selectedRetailer" class="no-content w-full h-[calc(100vh-256px)] flex">
                    <div class="no-content-container m-auto table text-center text-[#b7b7b7] dark:text-gray-500">
                      <img src="assets/images/select order-icon.svg" alt=""
                        class="w-[70px] h-[70px] mx-auto mb-[10px] block dark:invert dark:opacity-70" />
                      <strong>Select order to see details</strong>
                    </div>
                  </div>
                </div>

                <div
                  *ngIf="!savingOrder && selectedRetailer"
                  class="text-right pt-[15px]"
                >
                  <button
                    *ngIf="!savingOrder && !isChequeAdded"
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="
                      isCredit = false; isFullyPaymentAdded('Cheque Payment')
                    "
                  >
                    Add Cheque
                  </button>
                  <button
                    *ngIf="!savingOrder && isChequeAdded"
                    class="px-3 py-1.5 leading-none text-[13px] border border-red-600 rounded-[5px] font-primary bg-red-600 text-white hover:bg-red-700 hover:border-red-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="removeCheque()"
                  >
                    Remove Cheque
                  </button>
                  <button
                    *ngIf="!savingOrder && !isCreditAdded"
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="isCredit = true; isFullyPaymentAdded('Credit')"
                  >
                    Add Credit
                  </button>
                  <button
                    *ngIf="!savingOrder && isCreditAdded"
                    class="px-3 py-1.5 leading-none text-[13px] border border-red-600 rounded-[5px] font-primary bg-red-600 text-white hover:bg-red-700 hover:border-red-700 focus:outline-none transition-colors mr-2 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="removeCredit()"
                  >
                    Remove Credit
                  </button>

                  <button
                    [disabled]="
                      !orderDetails?.items?.length &&
                      !orderDetails?.returned_items?.length
                    "
                    class="px-3 py-1.5 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors mr-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="saveSpotSaleOrder()"
                  >
                    Save Order
                  </button>
                  <button
                    [disabled]="!orderDetails"
                    class="px-3 py-1.5 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="showCancelModal = true"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ===========================3======================== -->
          <div
            class="tab-pane tab_M p-0 PT-20 fade"
            *ngIf="currentTab === 3"
            [ngClass]="currentTab === 3 ? 'show active' : ''"
            id="pills-load"
            role="tabpanel"
            aria-labelledby="pills-load-tab"
          >
            <app-retailer-recovery
              [executionData]="executionData"
            ></app-retailer-recovery>
          </div>
          <!-- ====================END 3====================== -->
          <div
            class="tab-pane tab_M p-0 PT-20 fade"
            *ngIf="currentTab === 4"
            [ngClass]="currentTab === 4 ? 'show active' : ''"
            id="pills-load"
            role="tabpanel"
            aria-labelledby="pills-load-tab"
          >
            <div class="bg-[#f9f9f9] dark:bg-[#1d1d1d] px-[15px] border border-[#efefef] dark:border-[#333333] py-[10px] mt-6 rounded-lg relative mb-2">
              <div class="flex flex-wrap items-center gap-3">
                <div class="dark:text-gray-200">Order Booker:</div>
                <!-- Order Booker Select -->
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="selectedOrderBooker"
                    (ngModelChange)="getOrderBookerRoutes()"
                    nzPlaceHolder="Select Order Booker"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    class="w-full employee-select"
                  >
                    <nz-option nzDisabled nzLabel="Select Order Booker" [nzValue]="null"></nz-option>
                    <nz-option
                      *ngFor="let item of orderBookers"
                      [nzValue]="item"
                      [nzLabel]="item.employee_first_name + ' ' + item.employee_last_name"
                    ></nz-option>
                  </nz-select>
                </div>

                <!-- Route Select -->
                <div class="dark:text-gray-200">Route:</div>
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="selectedRoute"
                    (ngModelChange)="getRetaielrsByRoute($event)"
                    [nzPlaceHolder]="!selectedOrderBooker ? 'Select Order Booker First' : 'Select Route'"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    [nzDisabled]="!selectedOrderBooker"
                    class="w-full route-select"
                  >
                    <nz-option 
                      *ngIf="!selectedOrderBooker" 
                      nzDisabled 
                      nzLabel="Select Order Booker First" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option 
                      *ngIf="selectedOrderBooker" 
                      nzDisabled 
                      nzLabel="Select Route" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option
                      *ngFor="let item of bookerRoutes"
                      [nzValue]="item.route_id"
                      [nzLabel]="item.name"
                    ></nz-option>
                  </nz-select>
                </div>

                <!-- Retailer Select -->
                <div class="dark:text-gray-200">Retailer:</div>
                <div class="w-[240px]">
                  <nz-select
                    nzShowSearch
                    nzAllowClear
                    [(ngModel)]="recoveryRetailer"
                    (ngModelChange)="setRecoveryRetailer()"
                    [nzPlaceHolder]="!selectedRoute ? 'Select Route First' : 'Select Retailer'"
                    [nzDropdownMatchSelectWidth]="false"
                    [nzDropdownStyle]="{ 'z-index': '9999' }"
                    [nzDisabled]="!selectedRoute"
                    class="w-full retailer-select"
                  >
                    <nz-option 
                      *ngIf="!selectedRoute" 
                      nzDisabled 
                      nzLabel="Select Route First" 
                      [nzValue]="null"
                    ></nz-option>
                    <nz-option 
                      *ngIf="selectedRoute" 
                      nzDisabled 
                      nzLabel="Select Retailer" 
                      [nzValue]="null"
                    ></nz-option>
                    <ng-container *ngFor="let item of routeRetailers">
                      <nz-option
                        *ngIf="!item.isAdded"
                        [nzValue]="item"
                        [nzLabel]="item.retailer_name"
                      ></nz-option>
                    </ng-container>
                  </nz-select>
                </div>
              </div>
            </div>

            <div class="h-[calc(100vh-256px)]">
              <app-retailer-recovery
                *ngIf="isRecvoryRetailerCanged"
                [retailerId]="this.recoveryRetailer?.retailer_id"
                [assignment_idOutRoute]="this.executionData.assignment_id"
              ></app-retailer-recovery>
              <div class="col-12" *ngIf="isAdded">
                <app-loader-white></app-loader-white>
              </div>
            </div>
          </div>

          <div
            class="tab-pane tab_M p-0 PT-10 fade"
            *ngIf="currentTab === 5"
            [ngClass]="currentTab === 5 ? 'show active' : ''"
            id="pills-final"
            role="tabpanel"
            aria-labelledby="pills-final-tab"
          >
            <div class="text-[13px] pt-3">
              <div class="flex gap-3">
                <!-- Date -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-medium text-gray-900 dark:text-gray-300">Date:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ finalLoad?.dsr?.executed_date?.split(" ")[0] || "--" }}
                  </span>
                </div>
                
                <!-- Order Booker -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-medium text-gray-900 dark:text-gray-300">Order Booker:</strong>
                  <b class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ "--" }}
                  </b>
                </div>
                
                <!-- Territory -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-medium text-gray-900 dark:text-gray-300">Territory:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ finalLoad?.dsr?.territory || "--" }}
                  </span>
                </div>
                
                <!-- Total Outlets -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-medium text-gray-900 dark:text-gray-300">Total Outlets:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    {{ finalLoad?.dsr?.total_orders || "--" }}
                  </span>
                </div>
                
                <!-- Total Amount -->
                <div class="flex justify-between items-center w-full bg-[#f9f9f9] dark:bg-[#1d1d1d] border-b border-[#d1d1d1] dark:border-[#1d1d1d] p-[10px] leading-none rounded-md">
                  <strong class="font-primary font-medium text-gray-900 dark:text-gray-300">Total Amount:</strong>
                  <span class="font-[Rationale,sans-serif] text-[#0038ba] dark:text-neutral-200 text-[18px]">
                    Rs. {{ finalLoad?.dsr?.total_net_amount || 0 | number: "1.2-2" }}
                  </span>
                </div>
              </div>
            </div>

            <div class="flex flex-col w-full pt-3">
              <div *ngIf="!loading" class="flex w-full">
                <div class="flex-1 pr-3 pl-2"> 
                  <div class="flex items-center justify-between">
                    <h2 class="relative flex items-start text-base pl-0 mb-3 text-secondary dark:text-gray-300 before:content-[''] before:absolute before:w-[2px] before:h-[18px] before:bg-primary before:left-[-12px] before:top-[3px] font-primary font-medium">
                      Delivery &nbsp; <span class="font-light"> Challan</span></h2>
                  

                    <!-- Search Input -->
                    <div *ngIf="finalLoad?.dsr?.contents" class="mb-3 w-56 relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                      </div>
                      <input 
                        type="text" 
                        id="delivery-challan-filter-text-box" 
                        placeholder="Search products..." 
                        autocomplete="off"
                        class="w-56 pl-10 pr-4 py-2 h-[32px] border border-gray-300 dark:border-[#333333] rounded-lg bg-white dark:bg-[#1a1a1a] text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-primary dark:focus:border-primary focus:outline-none font-primary text-sm"
                        (input)="onDeliveryChallanQuickFilterChanged($event)" 
                      />
                    </div>

                  </div>
                  
                  <!-- AG Grid -->
                  <div *ngIf="finalLoad?.dsr?.contents && deliveryChallanColumnDefs.length > 0" class="ag-theme-quartz ag-grid-container w-full">
                    <ag-grid-angular 
                      [rowData]="finalLoad.dsr.contents" 
                      [columnDefs]="deliveryChallanColumnDefs"
                      [defaultColDef]="defaultColDef" 
                      [pagination]="true"
                      [paginationPageSize]="10"
                      [paginationPageSizeSelector]="[10, 20, 50, 100]"
                      [suppressPaginationPanel]="false"
                      [domLayout]="'autoHeight'"
                      [animateRows]="true"
                      [theme]="'legacy'"
                      [suppressHorizontalScroll]="false"
                      [suppressColumnVirtualisation]="true"
                      (gridReady)="onDeliveryChallanGridReady($event)">
                    </ag-grid-angular>
                  </div>
                </div>

                <div class="w-[370px] shrink-0">
                  <div class="bg-[#f8f8f8] dark:bg-[#1a1a1a] min-h-[calc(100vh-122px)] rounded-lg" *ngIf="finalLoad">
                    <div class="text-[#424242] dark:text-gray-300 px-5 py-[15px] relative shadow-none rounded-lg">
                      <!-- Header with Add Expense Button -->
                      <div class="flex items-center justify-between mb-4">
                        <h2 class="text-base font-semibold font-primary text-gray-900 dark:text-neutral-300">
                          Cash <span class="font-light">Report</span>
                        </h2>
                        <button
                          *ngIf="!isAdded"
                          class="px-3 py-1.5 text-[13px] leading-none font-primary text-white bg-primary border border-primary rounded-[5px] hover:bg-blue-700 hover:border-blue-700 transition-colors"
                          (click)="openExpenseModal()"
                        >
                          Add Expense
                        </button>
                        <button
                          *ngIf="isAdded"
                          class="px-3 py-1.5 text-xs font-primary text-white bg-primary border border-primary rounded-[5px] opacity-50 cursor-not-allowed flex items-center justify-center"
                          disabled
                        >
                          <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </button>
                      </div>

                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Gross Amount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_gross_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Trade Offer:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_trade_offer | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Trade Discount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_trade_discount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Special Discount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_special_discount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Extra Discount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_booker_discount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Loyalty Discount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_loyalty_discount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Total Tax:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_tax_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md text-[#0038ba] dark:text-neutral-200">
                        <strong class="font-semibold font-primary">Total Net Sale:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg">{{
                          finalLoad?.dsr?.total_net_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Expense:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_expense | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Return Amount:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_return_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Recovery:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_recovered_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md text-[#0038ba] dark:text-neutral-200">
                        <strong class="font-semibold font-primary">Total Net Receivable:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg">{{
                          finalLoad?.dsr?.total_net_after_recovery | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Cheque:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_cheque_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Credit:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_credit_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">Cash:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg text-gray-900 dark:text-neutral-400">{{
                          finalLoad?.dsr?.total_cash_amount | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md">
                        <strong class="font-semibold font-primary text-gray-900 dark:text-neutral-400">AMT. Received:</strong>
                        <input
                          type="number"
                          [(ngModel)]="amountReceived"
                          (keydown)="isNumber($event)"
                          class="w-20 text-right px-2 py-1 border border-gray-300 dark:border-[#333333] rounded-md bg-white dark:bg-[#1a1a1a] text-gray-900 dark:text-white focus:border-primary dark:focus:border-primary focus:outline-none font-[Rationale,sans-serif] text-lg leading-none"
                          placeholder="0"
                        />
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md text-[#0038ba] dark:text-neutral-200">
                        <strong class="font-semibold font-primary">Balance AMT:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg">{{
                          (finalLoad?.dsr?.total_amount_recieveable - amountReceived) || 0 | number: "1.2-2"
                          }}</span>
                      </div>
                      <div
                        class="bg-white dark:bg-[#252525] text-[13px] relative p-[10px] tracking-[0.5px] mb-[5px] mt-[5px] shadow-[0_2px_8px_#4f4f4f1a] leading-none flex justify-between items-center rounded-md text-[#0038ba] dark:text-neutral-200">
                        <strong class="font-semibold font-primary">Gross Weight:</strong>
                        <span class="font-[Rationale,sans-serif] leading-none text-lg">{{ finalLoad?.dsr?.total_weight || 0 | number: "1.2-2" }}Kg</span>
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="p-[0px_18px_10px_18px] flex flex-col gap-2">
                      <button
                        *ngIf="!loading"
                        class="w-full px-4 py-2 leading-none text-sm font-primary text-white bg-primary border border-primary rounded-[5px] hover:bg-blue-700 hover:border-blue-700 transition-colors"
                        (click)="generateDSR()"
                      >
                        Generate DSR
                      </button>
                      <button
                        *ngIf="loading"
                        type="button"
                        class="w-full px-4 py-2 leading-none text-sm font-primary text-white bg-primary border border-primary rounded-[5px] opacity-50 cursor-not-allowed flex items-center justify-center"
                        disabled
                      >
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </button>
                      <button
                        *ngIf="!loading"
                        [disabled]="+amountReceived < 0"
                        class="w-full px-4 py-2 leading-none text-sm font-primary text-white bg-primary border border-primary rounded-[5px] hover:bg-blue-700 hover:border-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        (click)="checkRecieveable()"
                      >
                        Mark Complete
                      </button>
                      <button
                        *ngIf="loading"
                        type="button"
                        class="w-full px-4 py-2 leading-none text-sm font-primary text-white bg-primary border border-primary rounded-[5px] opacity-50 cursor-not-allowed flex items-center justify-center"
                        disabled
                      >
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div *ngIf="loading" class="flex justify-center items-center w-full p-8">
                <app-loader-white></app-loader-white>
              </div>
            </div>
          </div>

          <!-- Previous/Next Navigation Buttons - Global for all tabs -->
          <div *ngIf="currentTab !== 5" class="flex justify-center gap-2 mt-4 p-3 bg-[#f6f6f6] dark:bg-[#1a1a1a] rounded-lg">
            <button type="button" (click)="changeTab(currentTab - 1,'prev')"
              [disabled]="currentTab === 1 || isSpotSaleActive || loading"
              class="px-6 py-2 leading-none text-[15px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-primary hover:text-white focus:bg-primary focus:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
              Previous
            </button>
            <button *ngIf="currentTab !== 4" type="button" (click)="changeTab(currentTab + 1,'next')"
              [disabled]="isSpotSaleActive || loading || currentTab === 5"
              class="px-6 py-2 leading-none text-[15px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-primary hover:text-white focus:bg-primary focus:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
              <div *ngIf="loading" class="inline-block animate-spin mr-2">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
              </div>
              {{ loading ? "" : "Next" }}
            </button>
            <button *ngIf="currentTab === 4" type="button" (click)="changeTab(currentTab + 1,'next')"
              [disabled]="isSpotSaleActive || loading"
              class="px-6 py-2 leading-none text-[15px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-primary hover:text-white focus:bg-primary focus:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
              Next
            </button>
          </div>
        </div>
      </div> 
</div>

<div
  *ngIf="showBillsModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="closeBillsModal()"
>
  <div
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-2xl mx-auto border-t-4 border-t-primary"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-300 font-primary">
        Print bill for this order
      </h5>
      <button
        type="button"
        id="close-bills"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="closeBillsModal()"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="px-6 py-5">
      <h2 class="text-base font-medium text-gray-800 dark:text-neutral-300 mb-6 font-primary">
        Select paper size for print
      </h2>

      <div class="grid grid-cols-2 gap-4">
        <button
          (click)="getBills('A4')"
          class="group flex flex-col items-center p-6 border border-gray-200 dark:border-neutral-700 rounded-lg hover:border-[#0038ba] dark:hover:border-[#ffffff] hover:shadow-lg transition-all duration-200 bg-white dark:bg-[#1f1f1f]"
        >
          <img
            class="w-12 h-12 mb-4 opacity-60 group-hover:opacity-100 transition-opacity grayscale dark:invert dark:grayscale"
            src="assets/images/a4.svg"
            alt="A4 Paper"
          />
          <strong class="text-sm text-gray-800 dark:text-neutral-400 group-hover:text-primary dark:group-hover:text-[#ffffff] transition-colors">
            A4 Portrait Paper
          </strong>
        </button>

        <button
          (click)="getBills('A5')"
          class="group flex flex-col items-center p-6 border border-gray-200 dark:border-neutral-700 rounded-lg hover:border-[#0038ba] dark:hover:border-[#ffffff] hover:shadow-lg transition-all duration-200 bg-white dark:bg-[#1f1f1f]"
        >
          <img
            class="w-12 h-12 mb-4 opacity-60 group-hover:opacity-100 transition-opacity grayscale dark:invert dark:grayscale"
            src="assets/images/a5.svg"
            alt="A5 Paper"
          />
          <strong class="text-sm text-gray-800 dark:text-neutral-400 group-hover:text-primary dark:group-hover:text-[#ffffff] transition-colors">
            A5 Landscape Paper
          </strong>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hold Order -->
<div
  id="order-hold-model"
  *ngIf="showHoldModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="closeHoldOrderModal($event)"
>
  <div 
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-lg mx-auto border-t-4 border-t-primary"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Hold <span class="font-light text-gray-600 dark:text-gray-400">Order</span>
      </h5>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="closeHoldOrderModal($event)"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="px-6 py-5">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Hold Reason<span class="text-red-500">*</span>
        </label>
        <input
          nz-input
          type="text"
          placeholder="Enter reason"
          required
          [(ngModel)]="holdOrderParams.hold_reason"
          class="payment-input rounded-md focus:border-primary hover:border-primary dark:bg-[#141414] dark:border-[#434343] dark:text-neutral-300 w-full"
        />
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-gray-50 dark:bg-[#151515] border-t border-gray-200 dark:border-[#303030] rounded-b-lg flex justify-end gap-3">
      <button
        type="button"
        id="close-hold-model"
        class="px-6 py-2 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors"
        (click)="closeHoldOrderModal($event)"
        aria-label="Close"
      >
        Cancel
      </button>
      <button
        type="button"
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors"
        (click)="holdOrder($event)"
        aria-label="Save"
      >
        Save
      </button>
    </div>
  </div>
</div>

<!-- Cancel Order -->
<div
  id="order-del"
  *ngIf="showCancelModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="showCancelModal = false"
>
  <div 
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-lg mx-auto border-t-4 border-t-red-600"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Cancel <span class="font-light text-gray-600 dark:text-gray-400">Order</span>
      </h5>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="showCancelModal = false"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="px-6 py-5">
      <p class="text-gray-700 dark:text-gray-300">Are you sure you want to cancel the order?</p>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-gray-50 dark:bg-[#151515] border-t border-gray-200 dark:border-[#303030] rounded-b-lg flex justify-end gap-3">
      <button
        type="button"
        id="close-del"
        class="px-6 py-2 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors"
        (click)="showCancelModal = false"
        aria-label="Close"
      >
        No
      </button>
      <button
        *ngIf="currentTab === 1"
        type="button"
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors"
        (click)="cancelOrder()"
      >
        Yes
      </button>
      <button
        *ngIf="currentTab === 2"
        type="button"
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors"
        (click)="cancelSpotSale()"
      >
        Yes
      </button>
    </div>
  </div>
</div>

<!-- Complete Execution -->
<div
  *ngIf="showCompleteModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="closeCompleteModal()"
>
  <div
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-lg mx-auto border-t-4 border-t-primary"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Complete <span class="font-light text-gray-600 dark:text-gray-400">Execution</span>
      </h5>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="closeCompleteModal()"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="px-6 py-5">
      <p class="text-gray-700 dark:text-gray-300">Are you sure you want to mark the order as completed?</p>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-gray-50 dark:bg-[#151515] border-t border-gray-200 dark:border-[#303030] rounded-b-lg flex justify-end gap-3">
      <button
        type="button"
        class="px-6 py-2 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors"
        (click)="closeCompleteModal()"
        aria-label="Close"
      >
        No
      </button>
      <button
        type="button"
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors"
        (click)="markCompelet()"
        aria-label="Confirm"
      >
        Yes
      </button>
    </div>
  </div>
</div>

<!-- Add Expense - Tailwind Modal -->
<div
  *ngIf="showExpenseModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4"
  (click)="closeExpenseModal()"
>
  <div 
    class="bg-white dark:bg-[#1f1f1f] rounded-lg shadow-xl w-full max-w-3xl mx-auto border-t-4 border-t-primary"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-[#333333]">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-neutral-200 font-primary">
        Add <span class="font-light text-gray-600 dark:text-gray-400">Expense</span>
      </h5>
      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
        (click)="closeExpenseModal()"
        aria-label="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div *ngIf="finalLoad" class="px-6 py-5">
        <!-- Expense Input Section -->
        <div class="flex gap-4 mb-6">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Expense Type
            </label>
            <nz-select
              #expenseType
              nzPlaceHolder="Select Expense Type"
              nzAllowClear
              class="w-full"
              [(ngModel)]="selectedExpenseType"
            >
              <nz-option
                *ngFor="let expType of finalLoad?.expense_types"
                [nzValue]="expType.id"
                [nzLabel]="expType.name"
              ></nz-option>
            </nz-select>
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Amount
            </label>
            <input 
              type="number" 
              id="expense-amount" 
              name="expense-amount"
              #expenseAmount
              [(ngModel)]="selectedExpenseAmount" 
              (keydown)="isNumber($event)" 
              class="w-full !h-[32px] px-3 border border-gray-300 dark:border-[#333333] rounded-[5px] bg-white dark:bg-[#141414] text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none hover:border-primary focus:border-primary font-primary text-sm"
              placeholder="0"
            >
          </div>
          <div class="flex items-end">
            <button
              type="button"
              (click)="addExpense({value: selectedExpenseType}, expenseAmount)"
              class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors"
            >
              Add
            </button>
          </div>
        </div>

        <!-- Expense List Table -->
        <div *ngIf="!isExpenseAdded" class="border border-gray-200 dark:border-[#333333] rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-[#f9f9f9] dark:bg-[#252525]">
                <tr>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-900 dark:text-gray-300 border-b border-gray-200 dark:border-[#333333]">
                    Expense Type
                  </th>
                  <th class="px-3 py-2 text-left text-sm font-medium text-gray-900 dark:text-gray-300 border-b border-gray-200 dark:border-[#333333]">
                    Amount
                  </th>
                  <th class="px-3 py-2 text-center text-sm font-medium text-gray-900 dark:text-gray-300 border-b border-gray-200 dark:border-[#333333]">
                    Action
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-[#1a1a1a]">
                <tr
                  *ngFor="let expense of finalLoad?.expense_detail"
                  class="border-b border-gray-200 dark:border-[#333333] hover:bg-gray-50 dark:hover:bg-[#252525]"
                >
                  <td class="px-3 py-2 text-sm text-gray-900 dark:text-gray-300">
                    {{ getExpense(expense.expense_type) }}
                  </td>
                  <td class="px-3 py-2 text-sm text-gray-900 dark:text-gray-300 w-[200px]">
                    {{ expense.amount }}
                  </td>
                  <td class="px-3 py-2 text-center w-[130px]">
                    <button
                      type="button"
                      (click)="removeExpense(expense.expense_type)"
                      class="px-3 py-1 text-[13px] leading-none font-primary text-white bg-red-600 border border-red-600 rounded-[5px] hover:bg-red-700 hover:border-red-700 transition-colors"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
                <tr *ngIf="!finalLoad?.expense_detail || finalLoad?.expense_detail.length === 0">
                  <td colspan="3" class="px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400">
                    No expenses added yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Loading State -->
        <div
          *ngIf="isExpenseAdded"
          class="flex justify-center items-center py-12"
        >
          <div class="h-10 w-10 rounded-full border-2 border-gray-300 border-t-primary dark:border-neutral-600 dark:border-t-[#4d7fff] animate-spin"></div>
        </div>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-gray-50 dark:bg-[#151515] border-t border-gray-200 dark:border-[#303030] rounded-b-lg flex justify-end gap-3">
      <button
        type="button"
        class="px-6 py-2 leading-none text-[13px] rounded-[5px] font-primary border border-primary dark:border-[#717171] bg-transparent text-primary dark:text-white dark:opacity-70 hover:bg-red-600 hover:border-red-600 dark:hover:border-red-600 hover:text-white focus:bg-red-600 focus:border-red-600 focus:text-white transition-colors"
        (click)="closeExpenseModal()"
        aria-label="Close"
      >
        Cancel
      </button>
      <button
        type="button"
        class="px-6 py-2 leading-none text-[13px] border border-primary rounded-[5px] font-primary bg-primary text-white hover:bg-blue-700 hover:border-blue-700 focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:border-gray-400"
        (click)="saveExpense()"
      >
        Save
      </button>
    </div>
  </div>
</div>
